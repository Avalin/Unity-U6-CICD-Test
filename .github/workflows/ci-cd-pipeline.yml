name: ğŸš€ CI/CD Pipeline (Test)

on:
  workflow_dispatch:
    inputs:
      validDeployTargets:
        type: string
        required: true
        default: '[]'
      targetPlatforms:
        type: string
        required: true
        default: '[]'
      metadataConfig:
        type: string
        required: true
      testDataConfig:
        type: string
        required: true
      artifactConfig:
        type: string
        required: true

permissions:
  contents: write

jobs:
  unpack_inputs:
    name: Unpack Inputs
    runs-on: ubuntu-latest
    outputs:
      projectName: ${{ steps.unpack.outputs.projectName }}
      skipTests: ${{ steps.unpack.outputs.skipTests }}
      testsOnly: ${{ steps.unpack.outputs.testsOnly }}
      buildType: ${{ steps.unpack.outputs.buildType }}
      version: ${{ steps.unpack.outputs.version }}
      retentionDays: ${{ steps.unpack.outputs.retentionDays }}
      requiresCombined: ${{ steps.unpack.outputs.requiresCombined }}
      skipPerPlatform: ${{ steps.unpack.outputs.skipPerPlatform }}
      unityVersion: ${{ steps.unpack.outputs.unityVersion }}
      useGitLfs: ${{ steps.unpack.outputs.useGitLfs }}
      editModePath: ${{ steps.unpack.outputs.editModePath }}
      playModePath: ${{ steps.unpack.outputs.playModePath }}
      timeoutMinutesTests: ${{ steps.unpack.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild: ${{ steps.unpack.outputs.timeoutMinutesBuild }}
      quietMode: ${{ steps.unpack.outputs.quietMode }}
    steps:
      - id: unpack
        run: |
          meta='${{ inputs.metadataConfig }}'
          artifact='${{ inputs.artifactConfig }}'
          testData='${{ inputs.testDataConfig }}'

          #Test Data Config
          echo "unityVersion=$(echo "$testData" | jq -r .unityVersion)" >> "$GITHUB_OUTPUT"
          echo "useGitLfs=$(echo "$testData" | jq -r .useGitLfs)" >> "$GITHUB_OUTPUT"
          echo "editModePath=$(echo "$testData" | jq -r .editModePath)" >> "$GITHUB_OUTPUT"
          echo "playModePath=$(echo "$testData" | jq -r .playModePath)" >> "$GITHUB_OUTPUT"
          echo "quietMode=$(echo "$testData" | jq -r .quietMode)" >> "$GITHUB_OUTPUT"

          # Metadata Config
          echo "projectName=$(echo "$meta" | jq -r .projectName)" >> "$GITHUB_OUTPUT"
          echo "skipTests=$(echo "$meta" | jq -r .skipTests)" >> "$GITHUB_OUTPUT"
          echo "testsOnly=$(echo "$meta" | jq -r .testsOnly)" >> "$GITHUB_OUTPUT"
          echo "buildType=$(echo "$meta" | jq -r .buildType)" >> "$GITHUB_OUTPUT"
          echo "version=$(echo "$meta" | jq -r .version)" >> "$GITHUB_OUTPUT"
          echo "retentionDays=$(echo "$meta" | jq -r .retentionDays)" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesTests=$(echo "$meta" | jq -r .timeoutMinutesTests)" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesBuild=$(echo "$meta" | jq -r .timeoutMinutesBuild)" >> "$GITHUB_OUTPUT"

          # Artifacts Config
          echo "requiresCombined=$(echo "$artifact" | jq -r .requiresCombined)" >> "$GITHUB_OUTPUT"
          echo "skipPerPlatform=$(echo "$artifact" | jq -r .skipPerPlatform)" >> "$GITHUB_OUTPUT"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. Run Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  run_tests:
    name: Run Tests
    if: ${{ needs.unpack_inputs.outputs.skipTests != 'true' }}
    needs: unpack_inputs
    uses: avalin/unity-ci-templates/.github/workflows/step-1-test.yml@v1
    with:
      unityVersion: ${{ needs.unpack_inputs.outputs.unityVersion }}
      useGitLfs: ${{ needs.unpack_inputs.outputs.useGitLfs }}
      editModePath: ${{ needs.unpack_inputs.outputs.editModePath }}
      playModePath: ${{ needs.unpack_inputs.outputs.playModePath }}
      timeoutMinutes: ${{ fromJson(needs.unpack_inputs.outputs.timeoutMinutesTests) }}
      quietMode: ${{ needs.unpack_inputs.outputs.quietMode }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. Build
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build
    needs: 
      - unpack_inputs
      - run_tests
    if: >
      always() &&
      needs.unpack_inputs.outputs.testsOnly != 'true' &&
      (needs.run_tests.result == 'success' || needs.run_tests.result == 'skipped')
    uses: avalin/unity-ci-templates/.github/workflows/step-2-build.yml@v1
    with:
      # If the event is a push with a tag, force buildType to "release"; otherwise, use the input.
      projectName: ${{ needs.unpack_inputs.outputs.projectName }}
      version: ${{ needs.unpack_inputs.outputs.version }}
      targetPlatforms: ${{ inputs.targetPlatforms }}
      combineArtifacts: ${{ needs.unpack_inputs.outputs.requiresCombined }}
      timeoutMinutes: ${{ fromJson(needs.unpack_inputs.outputs.timeoutMinutesBuild) }}
      retentionDays: ${{ fromJson(needs.unpack_inputs.outputs.retentionDays) }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. Release
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Release
    needs: 
      - unpack_inputs
      - build
    if: > 
      always() &&
      needs.unpack_inputs.outputs.testsOnly != 'true' &&
      needs.build.result == 'success' && 
      (
        needs.unpack_inputs.outputs.buildType == 'release' || 
        needs.unpack_inputs.outputs.buildType == 'release_candidate'
      )
    uses: avalin/unity-ci-templates/.github/workflows/step-3-release.yml@v1
    with:
      buildType: ${{ needs.unpack_inputs.outputs.buildType }}
      version: ${{ needs.unpack_inputs.outputs.version }}
      projectName: ${{ needs.unpack_inputs.outputs.projectName }}
      targetPlatforms: ${{ inputs.targetPlatforms }}
      combineArtifacts: ${{ needs.unpack_inputs.outputs.requiresCombined }}
      skipPerPlatformArtifacts: ${{ needs.unpack_inputs.outputs.skipPerPlatform }}
    secrets: inherit

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. Deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy
    needs: 
      - unpack_inputs
      - build
      - release
    if: > 
      always() &&
       needs.unpack_inputs.outputs.testsOnly != 'true' &&
       needs.release.result == 'success' &&
       inputs.validDeployTargets != '[]'
    uses: avalin/unity-ci-templates/.github/workflows/step-4-deploy.yml@v1
    with:
      buildType: ${{ needs.unpack_inputs.outputs.buildType }}
      version: ${{ needs.unpack_inputs.outputs.version }}
      projectName: ${{ needs.unpack_inputs.outputs.projectName }}
      deployTargets: ${{ inputs.validDeployTargets }}
      targetPlatforms: ${{ inputs.targetPlatforms }}
      hasCombinedArtifacts: ${{ needs.unpack_inputs.outputs.requiresCombined }}
      artifactSource: build
    secrets: inherit

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5. Notify
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: Notify
    needs: 
      - unpack_inputs
      - run_tests
      - build
      - release
      - deploy
    if: > 
      always() && 
      needs.unpack_inputs.outputs.testsOnly != 'true' &&
      (
        needs.unpack_inputs.outputs.buildType == 'release' || 
        needs.unpack_inputs.outputs.buildType == 'release_candidate'
      )
    uses: avalin/unity-ci-templates/.github/workflows/step-5-notify.yml@v1
    with:
      version: ${{ needs.unpack_inputs.outputs.version }}
      releaseResult: ${{ needs.release.result }}
      releaseErrorMessage: ${{ needs.release.outputs.releaseErrorMessage }}
      deployResult: ${{ needs.deploy.result }}
      testsHasFails: ${{ needs.run_tests.outputs.hasFails }}
      testsTotal: ${{ needs.run_tests.outputs.totalTests }}
      testsPassed: ${{ needs.run_tests.outputs.passedTests }}
      testsFailedNames: ${{ needs.run_tests.outputs.failedTestNames }}
    secrets: inherit